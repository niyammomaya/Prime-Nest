<!DOCTYPE html>
<html>
<head>
    <title>PrimeNest Store</title>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header style="display:flex; justify-content:space-between; align-items:center;">
        <nav style="display:flex; gap:14px; align-items:center;">
            <a href="/">Home</a>
            <a href="/store">Store</a>
            <a href="/cart.html">Cart</a>
        </nav>
        <div class="controls" style="margin-top:0;">
            <a href="/dashboard"><button type="button">Dashboard</button></a>
            <button type="button" onclick="signOut()">Sign out</button>
        </div>
    </header>
    <main>
        <div class="layout">
            <section>
                <h2>Shop Products</h2>
                <p class="tagline">Browse and add to cart. Click an item for details.</p>
                <div class="controls">
                    <input id="searchInput" type="text" placeholder="Search by name">
                    <details style="display:inline-block; border:1px solid #d1d5db; border-radius:6px; padding:6px 10px; background:#f9fafb;">
                        <summary style="cursor:pointer; list-style:none;">Filters ▾</summary>
                        <div class="stack" style="margin-top:8px; gap:6px; min-width:240px;">
                    <select id="filterCategory">
                        <option value="">All categories</option>
                        <option value="shoes">Shoes</option>
                        <option value="bags">Bags</option>
                        <option value="electronics">Electronics</option>
                        <option value="apparel">Apparel</option>
                    </select>
                    <div style="display:flex; gap:6px;">
                        <input id="minPrice" type="number" min="0" step="1" placeholder="Min $" style="width:100%;">
                        <input id="maxPrice" type="number" min="0" step="1" placeholder="Max $" style="width:100%;">
                    </div>
                            <label class="muted" style="display:flex; flex-direction:column; gap:4px;">
                                Min rating:
                                <div style="display:flex; gap:8px; align-items:center;">
                                    <input id="minRatingValue" type="text" value="1" style="width:60px; padding:6px 8px; border:1px solid #d1d5db; border-radius:6px;">
                                    <input id="minRating" type="range" min="1" max="5" step="0.1" value="1">
                                </div>
                                <span class="muted" style="font-size:12px;">Type or drag to set minimum stars.</span>
                            </label>
                            <label class="muted" style="display:flex; flex-direction:column; gap:4px;">
                                Use case(s):
                                <select id="useCaseSelect" multiple size="6" style="padding:6px 8px; border:1px solid #d1d5db; border-radius:6px; min-width:200px;">
                                </select>
                                <span class="muted" style="font-size:12px;">Select one or more. Leave empty for any.</span>
                            </label>
                        </div>
                    </details>
                    <select id="sortBy">
                        <option value="">Sort</option>
                        <option value="price-asc">Price: Low to High</option>
                        <option value="price-desc">Price: High to Low</option>
                        <option value="rating-desc">Rating: High to Low</option>
                        <option value="name-asc">Name: A to Z</option>
                    </select>
                    <button type="button" onclick="loadProducts()">Search</button>
                    <button type="button" onclick="clearSearch()">Clear</button>
                </div>
                <div id="status" class="muted"></div>
                <div id="products" class="grid"></div>
            </section>

            <section id="cart">
                <h2>Your Cart</h2>
                <p class="tagline">Items you've added plus a running total.</p>
                <div id="cart-status" class="muted" style="margin-bottom:8px;"></div>
                <div id="cart-items" class="stack"></div>
                <div id="cart-total" class="cart-total"></div>
            </section>
        </div>
    </main>

    <main style="max-width:1200px; margin:20px auto;">
        <section>
            <h2>Sample Bundles</h2>
            <p class="tagline">Quick picks for common campus needs.</p>
            <div class="grid">
                <div class="card">
                    <h3>College Essentials</h3>
                    <p class="muted">Ready-to-go basics for daily campus life.</p>
                    <ul class="muted" style="padding-left:18px;">
                        <li>Canvas Sneakers</li>
                        <li>Day Backpack</li>
                        <li>Crew Socks (3-pack)</li>
                        <li>Cotton Tee</li>
                    </ul>
                    <div class="controls">
                        <button type="button" onclick="addBundle(['MOCK-SHOE-1','MOCK-BAG-1','MOCK-SOCK-1','MOCK-TEE-1'])">Add bundle to cart</button>
                    </div>
                </div>
                <div class="card">
                    <h3>Study & Focus</h3>
                    <p class="muted">Gear to keep you focused in class and the library.</p>
                    <ul class="muted" style="padding-left:18px;">
                        <li>Noise Canceling Headphones</li>
                        <li>Messenger Bag</li>
                        <li>In-Ear Buds (backup)</li>
                        <li>Canvas Sneakers</li>
                    </ul>
                    <div class="controls">
                        <button type="button" onclick="addBundle(['MOCK-HEAD-2','MOCK-BAG-3','MOCK-HEAD-3','MOCK-SHOE-1'])">Add bundle to cart</button>
                    </div>
                </div>
                <div class="card">
                    <h3>Weekend Travel</h3>
                    <p class="muted">Pack light for trips home or quick getaways.</p>
                    <ul class="muted" style="padding-left:18px;">
                        <li>Weekend Duffel</li>
                        <li>Day Backpack</li>
                        <li>Trail Runners</li>
                        <li>Wireless Headphones</li>
                    </ul>
                    <div class="controls">
                        <button type="button" onclick="addBundle(['MOCK-BAG-2','MOCK-BAG-1','MOCK-SHOE-2','MOCK-HEAD-1'])">Add bundle to cart</button>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <main style="max-width:1200px; margin:20px auto;">
        <!-- Reviews section removed per request -->
    </main>

    <script>
        async function loadProducts() {
            const search = document.getElementById('searchInput').value.trim();
            const categoryFilter = document.getElementById('filterCategory').value;
            const minPriceVal = toNumber(document.getElementById('minPrice').value);
            const maxPriceVal = toNumber(document.getElementById('maxPrice').value);
            const minRatingVal = toNumber(document.getElementById('minRating').value);
            const useCaseFilter = getSelectedUseCases();
            const sortBy = document.getElementById('sortBy').value;
            const statusEl = document.getElementById('status');
            const container = document.getElementById('products');
            statusEl.textContent = 'Loading products...';
            container.innerHTML = '';

            try {
                let url = '/product-catalog/search';
                if (search) {
                    url += '?key=' + encodeURIComponent(search);
                }
                const payload = {
                    category: categoryFilter || null,
                    min_price: minPriceVal,
                    max_price: maxPriceVal,
                    min_rating: minRatingVal,
                    use_case: useCaseFilter,
                    sortBy
                };
                const res = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!res.ok) {
                    statusEl.textContent = 'Could not load products.';
                    renderProducts([], statusEl);
                    return;
                }
                const data = await res.json();
                let results = data.results || [];
                results = filterList(results, { keyword: search, categoryFilter, minPriceVal, maxPriceVal, minRatingVal, sortBy, useCaseFilter });
                if (!results || results.length === 0) {
                    statusEl.textContent = 'No matches found.';
                    renderProducts([], statusEl);
                    return;
                }
                statusEl.textContent = `${results.length} products`;
                renderProducts(results, statusEl);
            } catch (err) {
                statusEl.textContent = 'Error loading products.';
                renderProducts([], statusEl);
                console.error(err);
            }
        }

        function getSelectedUseCases() {
            const select = document.getElementById('useCaseSelect');
            return Array.from(select.selectedOptions || []).map(o => o.value).filter(Boolean);
        }

        function filterList(list, { keyword, categoryFilter, minPriceVal, maxPriceVal, minRatingVal, sortBy, useCaseFilter }) {
            const k = (keyword || "").toLowerCase();
            const useCases = new Set((useCaseFilter || []).map(v => v.toLowerCase()));
            const allowedCategories = ['shoes', 'bags', 'electronics', 'apparel'];
            return (list || []).filter(p => {
                const matchesAllowed = allowedCategories.includes((p.category || '').toLowerCase());
                const matchesText = !k || (p.name || '').toLowerCase().includes(k);
                const matchesCat = !categoryFilter || (p.category || '').toLowerCase() === categoryFilter.toLowerCase();
                const priceVal = p.discounted_price ?? p.price ?? 0;
                const matchesMinPrice = !minPriceVal || priceVal >= minPriceVal;
                const matchesMaxPrice = !maxPriceVal || priceVal <= maxPriceVal;
                const ratingVal = (typeof p.average_rating === 'number') ? p.average_rating : parseFloat(p.average_rating);
                const matchesRating = !minRatingVal || (ratingVal && ratingVal >= minRatingVal);
                const productUseCases = normalizeUseCases(p.use_cases).map(u => u.toLowerCase());
                const matchesUseCase = useCases.size === 0 || productUseCases.some(u => useCases.has(u));
                return matchesAllowed && matchesText && matchesCat && matchesMinPrice && matchesMaxPrice && matchesRating && matchesUseCase;
            }).sort((a, b) => sortProducts(a, b, sortBy));
        }

        function clearSearch() {
            document.getElementById('searchInput').value = '';
            document.getElementById('minPrice').value = '';
            document.getElementById('maxPrice').value = '';
            document.getElementById('minRating').value = 1;
            updateRatingLabel();
            document.getElementById('filterCategory').value = '';
            const useCaseSelect = document.getElementById('useCaseSelect');
            if (useCaseSelect) Array.from(useCaseSelect.options).forEach(opt => opt.selected = false);
            document.getElementById('sortBy').value = '';
            loadProducts();
        }

        function renderProducts(products, statusEl) {
            const container = document.getElementById('products');
            container.innerHTML = '';
            if (!products || products.length === 0) {
                container.innerHTML = '<p class="muted">No matches found.</p>';
                if (statusEl) statusEl.textContent = '';
                return;
            }
            products.forEach(p => {
                const desc = cleanText(p.long_description || p.description || 'No description.');
                const snippet = desc.length > 140 ? desc.substring(0, 140) + '...' : desc;
                const card = document.createElement('div');
                card.className = 'card';
                const basePrice = p.price ?? 0;
                const salePrice = p.discounted_price ?? p.price ?? 0;
                const hasDiscount = p.discounted_price && p.discounted_price !== p.price;
                const percentOff = hasDiscount ? Math.round((1 - (salePrice / basePrice)) * 100) : null;
                const reviewCount = typeof p.review_count === 'number'
                    ? p.review_count
                    : (Array.isArray(p.rating_distribution) ? p.rating_distribution.reduce((a, b) => a + b, 0) : 0);
                card.innerHTML = `
                    <h3>${p.name || 'Unnamed Product'}</h3>
                    <div class="muted">${formatCategory(p.category)}</div>
                    <div class="stars">
                        ${renderStars(p.average_rating)} <span class="muted" style="color:#4b5563;">${p.average_rating ? p.average_rating.toFixed(1) : 'N/A'}</span>
                        <span class="muted" data-review-btn="${p.product_ID}" style="margin-left:8px; cursor:pointer; text-decoration:underline; color:#2563eb;">${reviewCount || 'No'} reviews</span>
                    </div>
                    <div class="price">$${salePrice.toFixed(2)}</div>
                    ${hasDiscount ? `<div class="muted">Usually is $${basePrice.toFixed(2)} (${percentOff}% off)</div>` : ''}
                    <p class="muted" style="min-height:40px;">${snippet}</p>
                    <div class="muted" data-review-box="${p.product_ID}" style="display:none;"></div>
                    <div class="controls">
                        <input type="number" min="1" value="1" style="width:70px;" aria-label="Quantity" />
                        <button type="button" data-product="${p.product_ID}">Add to cart</button>
                        <button type="button" data-product="${p.product_ID}" data-action="buy-now" style="background:#065f46;">Buy now</button>
                    </div>
                `;
                const qtyInput = card.querySelector('input[type="number"]');
                const btn = card.querySelector('button');
                const buyBtn = card.querySelector('button[data-action="buy-now"]');
                const reviewBtn = card.querySelector(`[data-review-btn="${p.product_ID}"]`);
                btn.addEventListener('click', () => addToCart(p, parseInt(qtyInput.value, 10) || 1));
                buyBtn.addEventListener('click', () => buyNow(p, parseInt(qtyInput.value, 10) || 1));
                reviewBtn.addEventListener('click', () => toggleReviews(p.product_ID, card));
                card.addEventListener('click', async (e) => {
                    if (e.target.tagName.toLowerCase() === 'button' || e.target.tagName.toLowerCase() === 'input') return;
                    await showDetails(p, card);
                });
                container.appendChild(card);
            });
        }

        function renderStars(rating) {
            if (!rating || rating <= 0) return "☆☆☆☆☆";
            const full = Math.min(5, Math.floor(rating));
            const half = (rating - full) >= 0.5 ? 1 : 0;
            const empty = 5 - full - half;
            return "★".repeat(full) + (half ? "⯪" : "") + "☆".repeat(empty);
        }

        function formatCategory(cat) {
            if (!cat) return '';
            return cat.charAt(0).toUpperCase() + cat.slice(1);
        }

        function cleanText(text) {
            if (!text) return '';
            return text.replace(/<[^>]*>/g, ' ').replace(/\s+/g, ' ').trim();
        }

        function toNumber(val) {
            const n = parseFloat(val);
            return isNaN(n) ? null : n;
        }

        function updateRatingLabel(fromInput) {
            const slider = document.getElementById('minRating');
            const input = document.getElementById('minRatingValue');
            if (fromInput) {
                let val = parseFloat(input.value);
                if (isNaN(val)) val = 1;
                val = Math.min(5, Math.max(1, val));
                input.value = val.toFixed(1);
                slider.value = val.toFixed(1);
            } else {
                const val = parseFloat(slider.value);
                input.value = val.toFixed(1);
            }
        }

        function sortProducts(a, b, sortBy) {
            const priceA = a.discounted_price ?? a.price ?? 0;
            const priceB = b.discounted_price ?? b.price ?? 0;
            const ratingA = a.average_rating ?? 0;
            const ratingB = b.average_rating ?? 0;
            switch (sortBy) {
                case 'price-asc':
                    return priceA - priceB;
                case 'price-desc':
                    return priceB - priceA;
                case 'rating-desc':
                    return ratingB - ratingA;
                case 'name-asc':
                    return (a.name || '').localeCompare(b.name || '');
                default:
                    return 0;
            }
        }

        async function showDetails(product, card) {
            const detailId = `detail-${product.product_ID}`;
            if (document.getElementById(detailId)) {
                document.getElementById(detailId).remove();
                return;
            }
            const detail = document.createElement('div');
            detail.id = detailId;
            detail.className = 'muted';
            detail.textContent = 'Loading details...';
            card.appendChild(detail);
            try {
                const res = await fetch('/product-catalog/' + encodeURIComponent(product.product_ID));
                if (!res.ok) {
                    throw new Error('Could not load details');
                }
                const data = await res.json();
                const description = cleanText(data.description || product.long_description || product.description || 'No description.');
                const maker = data.manufacturer || product.manufacturer || 'Generic Co.';
                const uses = normalizeUseCases(data.use_cases || product.use_cases);
                detail.innerHTML = `
                    <div class="muted">Product ID: ${product.product_ID}</div>
                    <div class="muted">Manufacturer: ${maker}</div>
                    <div class="muted" style="font-size:13px; line-height:1.4;">${description}</div>
                    <div class="muted" style="margin-top:6px;">Use cases:</div>
                    <div class="muted" style="display:flex; gap:6px; flex-wrap:wrap; margin-top:4px;">
                        ${uses.map(u => `<span class="pill">${u}</span>`).join('')}
                    </div>
                `;
            } catch (err) {
                const description = cleanText(product.long_description || product.description || 'No description.');
                const maker = product.manufacturer || 'Generic Co.';
                const uses = normalizeUseCases(product.use_cases);
                detail.innerHTML = `
                    <div class="muted">Product ID: ${product.product_ID}</div>
                    <div class="muted">Manufacturer: ${maker}</div>
                    <div class="muted" style="font-size:13px; line-height:1.4;">${description}</div>
                    <div class="muted" style="margin-top:6px;">Use cases:</div>
                    <div class="muted" style="display:flex; gap:6px; flex-wrap:wrap; margin-top:4px;">
                        ${uses.map(u => `<span class="pill">${u}</span>`).join('')}
                    </div>
                `;
            }
        }

        async function addToCart(product, quantity) {
            const productId = product.product_ID;
            const cartStatus = document.getElementById('cart-status');
            try {
                const res = await fetch('/shopping-cart/products', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        product_ID: productId,
                        quantity,
                        name: product.name,
                        price: product.discounted_price ?? product.price,
                        category: product.category,
                        description: product.description
                    })
                });
                if (res.status === 401) {
                    cartStatus.textContent = 'Please log in first.';
                    return;
                }
                if (!res.ok) {
                    const msg = await res.text();
                    cartStatus.textContent = 'Could not add to cart: ' + msg;
                    return;
                }
                cartStatus.textContent = 'Added to cart.';
                loadCart();
            } catch (err) {
                cartStatus.textContent = 'Error adding to cart.';
                console.error(err);
            }
        }

        async function addBundle(productIds) {
            const statusEl = document.getElementById('cart-status');
            for (const id of productIds) {
                try {
                    const res = await fetch('/product-catalog/' + encodeURIComponent(id));
                    if (!res.ok) continue;
                    const prod = await res.json();
                    await addToCart(prod, 1);
                } catch (err) {
                    console.error('Bundle add failed for', id, err);
                }
            }
            statusEl.textContent = 'Bundle added (items added individually).';
        }

        async function buyNow(product, quantity) {
            const statusEl = document.getElementById('cart-status');
            statusEl.textContent = 'Creating checkout...';
            try {
                const res = await fetch('/create-checkout-session', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        product_ID: product.product_ID,
                        quantity,
                        name: product.name,
                        price: product.discounted_price ?? product.price,
                        description: product.description
                    })
                });
                if (!res.ok) {
                    const msg = await res.text();
                    statusEl.textContent = 'Checkout failed: ' + msg;
                    return;
                }
                const data = await res.json();
                if (data.url) {
                    window.location = data.url;
                } else {
                    statusEl.textContent = 'Checkout failed: no session URL.';
                }
            } catch (err) {
                statusEl.textContent = 'Checkout error.';
                console.error(err);
            }
        }

        async function toggleReviews(productId, card) {
            const box = card.querySelector(`[data-review-box="${productId}"]`);
            if (!box) return;
            if (box.style.display === 'block') {
                box.style.display = 'none';
                box.innerHTML = '';
                return;
            }
            box.style.display = 'block';
            box.textContent = 'Loading...';
            try {
                const res = await fetch('/product-reviews/' + encodeURIComponent(productId));
                if (!res.ok) {
                    box.textContent = 'No reviews found.';
                    return;
                }
                const data = await res.json();
                const dist = data.rating_distribution || [];
                const total = dist.reduce((a, b) => a + b, 0);
                const max = Math.max(...dist, 1);
                const wrapper = document.createElement('div');
                wrapper.className = 'stack';
                dist.forEach((count, idx) => {
                    const score = idx + 1;
                    const pct = Math.round((count / max) * 100);
                    const bar = document.createElement('div');
                    bar.innerHTML = `
                        <div class="muted" style="display:flex; align-items:center; gap:8px;">
                            <span style="width:40px;">${score}★</span>
                            <div style="background:#e5e7eb; flex:1; height:10px; border-radius:999px; overflow:hidden;">
                                <div style="width:${pct}%; height:10px; background:#2563eb;"></div>
                            </div>
                            <span>${count}</span>
                        </div>
                    `;
                    wrapper.appendChild(bar);
                });
                const summary = document.createElement('div');
                summary.className = 'muted';
                summary.textContent = `Total reviews: ${total}`;
                box.innerHTML = '';
                box.appendChild(wrapper);
                box.appendChild(summary);
                const btn = card.querySelector(`[data-review-btn="${productId}"]`);
                if (btn) btn.textContent = `${total || 'No'} reviews`;
            } catch (err) {
                box.textContent = 'Error loading reviews.';
            }
        }

        async function loadCart() {
            const cartEl = document.getElementById('cart-items');
            const totalEl = document.getElementById('cart-total');
            cartEl.innerHTML = '<p class="muted">Loading cart...</p>';
            totalEl.textContent = '';
            try {
                const res = await fetch('/shopping-cart');
                if (res.status === 401) {
                    cartEl.innerHTML = '<p class="muted">Please log in to view your cart.</p>';
                    totalEl.textContent = '';
                    return;
                }
                if (!res.ok) {
                    cartEl.innerHTML = '<p class="muted">Could not load cart.</p>';
                    totalEl.textContent = '';
                    return;
                }
                const data = await res.json();
                if (data.items && data.items.length) {
                    const grouped = groupByCategory(data.items);
                    const list = document.createElement('div');
                    list.className = 'stack';
                    Object.keys(grouped).forEach(cat => {
                        const header = document.createElement('div');
                        header.className = 'muted';
                        header.textContent = (cat || 'Other').toUpperCase();
                        list.appendChild(header);
                        grouped[cat].forEach(item => {
                            const row = document.createElement('div');
                            row.className = 'card cart-item';
                            row.innerHTML = `
                                <div>
                                    <strong>${item.name}</strong>
                                    <div class="muted">ID: ${item.product_ID}</div>
                                    <div class="muted">Price: $${(item.price ?? 0).toFixed(2)}</div>
                                    <div class="muted">Qty: ${item.quantity}</div>
                                </div>
                                <div style="text-align:right;">
                                    <div class="price">$${(item.price * item.quantity).toFixed(2)}</div>
                                    <div class="controls">
                                        <button type="button" data-action="remove" style="background:#d14343;">Remove</button>
                                    </div>
                                </div>
                            `;
                            row.querySelector('button[data-action="remove"]').onclick = () => removeCartItem(item.product_ID);
                            list.appendChild(row);
                        });
                    });
                    cartEl.innerHTML = '';
                    cartEl.appendChild(list);
                    totalEl.textContent = 'Total: $' + (data.totalCost || 0).toFixed(2);
                } else {
                    cartEl.innerHTML = '<p class="muted">Your cart is empty - start shopping in the Store!</p>';
                    totalEl.textContent = '';
                }
            } catch (err) {
                cartEl.innerHTML = '<p class="muted">Error loading cart.</p>';
                totalEl.textContent = '';
                console.error(err);
            }
        }

        function normalizeUseCases(raw) {
            if (Array.isArray(raw)) return raw.filter(Boolean);
            if (!raw) return [];
            return String(raw).split(',').map(u => u.trim()).filter(Boolean);
        }

        async function removeCartItem(productId) {
            try {
                const res = await fetch('/shopping-cart/products/' + encodeURIComponent(productId), {
                    method: 'DELETE'
                });
                if (!res.ok) {
                    const msg = await res.text();
                    alert('Could not remove item: ' + msg);
                    return;
                }
                loadCart();
            } catch (err) {
                alert('Error removing item');
            }
        }

        function groupByCategory(items) {
            return items.reduce((acc, item) => {
                const cat = item.category || 'Other';
                if (!acc[cat]) acc[cat] = [];
                acc[cat].push(item);
                return acc;
            }, {});
        }

        async function loadUseCaseOptions() {
            const select = document.getElementById('useCaseSelect');
            if (!select) return;
            select.innerHTML = '<option disabled>Loading...</option>';
            try {
                const res = await fetch('/product-catalog/use-cases');
                if (!res.ok) throw new Error('Failed to load use cases');
                const list = await res.json();
                select.innerHTML = '';
                (list || []).forEach(u => {
                    const opt = document.createElement('option');
                    opt.value = u;
                    opt.textContent = u;
                    select.appendChild(opt);
                });
            } catch (err) {
                select.innerHTML = '';
            }
        }

        // initial load
        loadUseCaseOptions().finally(() => loadProducts());
        loadCart();
        updateRatingLabel();
        document.getElementById('minRating').addEventListener('input', () => updateRatingLabel(false));
        document.getElementById('minRatingValue').addEventListener('change', () => updateRatingLabel(true));

        async function signOut() {
            await fetch("/logout", { method: "POST", headers: { "Content-Type": "text/html" } });
            document.location = "/";
        }
    </script>
</body>
</html>
